

Converting from SDoH brat `.ann` files to CAS XMI
=================================================

The following two scripts are Python-based tools to convert the brat
annotated corpus provided as part of the 2022 n2c2 Track 2 Shared Task
on Social Determinants of Health into standard CAS XMI annotation
schemas.

Both scripts take four named arguments indicating:
- the input directory of the brat `.txt` files (`--txt-root`)
- the input directory of the brat `.ann` files (`--brat-root`)
- the output directory of the CAS XMI files (`--cas-root`)
- the input directory of the brat `.txt` files (`--types-file`)

The text and ann files, as provided by the Shared Task are in the same
folder but don't necessarily need to be.  The output folder contents
will be overwritten with new files.  The type system XML file should
contain all necessary SHARPn types.  An easy default file is the type
system file provided with cTAKES.

SHARPn
------

- convert-n2c2-sdoh-brat-to-sharpn.py
  
.. code-block::  bash

    export SDOH_DIR=Track2_SubtaskA/Annotations/dev/mimic
    mkdir /tmp/sdoh-sharpn

    python convert-n2c2-sdoh-brat-to-sharpn.py \
           --txt-root ${SDOH_DIR} \
           --brat-root ${SDOH_DIR} \
           --cas-root /tmp/sdoh-sharpn \
           --types-file /path/to/apache-ctakes-4.0.0.1/resources/org/apache/ctakes/typesystem/types/TypeSystem.xml


OMOP CDM
--------

- convert-n2c2-sdoh-brat-to-omop-cdm.py

.. code-block::  bash

    export SDOH_DIR=Track2_SubtaskA/Annotations/dev/mimic
    mkdir /tmp/sdoh-omop

    python convert-n2c2-sdoh-brat-to-omop-cdm.py \
           --txt-root ${SDOH_DIR} \
           --brat-root ${SDOH_DIR} \
           --cas-root /tmp/sdoh-omop \
           --types-file /path/to/apache-ctakes-4.0.0.1/resources/org/apache/ctakes/typesystem/types/TypeSystem.xml


Augmenting Laboratory Test Names with Value Annotations
=======================================================

Data Prep
---------

Download and unzip the two data files containing raw note contents
(``train.zip`` and ``test.zip``) for the n2c2 2019 Track 3 into the
same parent folder containing your redacted corpus available via:
https://github.com/MUSC-TBIC/2010-i2b2-VA-Challenge-Corpus-Augmentations

Your file tree should look like this:

.. code-block::  bash
   
    cd /path/to/redacted-corpus
    tree -d
   
    .
    |-- test
    |   |-- test_norm_cui_replaced_with_unk
    |   |-- test_note
    |   `-- test_redacted
    `-- train
        |-- train_norm
        |-- train_note
        `-- train_redacted


The provided script ``patch_2019_n2c2_track-3_corpus.py`` takes two
arguments:  an input directory containing the redacted brat annotation
files (i.e., ``train_redacted/*`` and ``test_redacted/*``) and an
output directory for writing new annotation files.  All ``[redacted]``
spans of text from the source corpus will be replaced with the
matching substrings from the original notes.

The current version of this script treats all spans are continuous. As
such, the discontinous annotation spans, indicated by a semicolon in
the ann file offsets (e.g., '4755 4760;4771 4779'), will be
represented by the fully encompassing text span. That is, we treat
'4755 4760;4771 4779' as equivalent to '4755 4779' for the purposes of
pulling substrings.

.. code-block::  bash
    python3 \
        corpus-utils/n2c2/patch_2019_n2c2_track-3_corpus.py \
	--input-dir /path/to/redacted-corpus \
	--output-dir /path/to/patched-corpus


We recommend using the same root directory for both the redacted
corpus and the patched corpus. If these directories are the same, then
re-running ``tree`` (as above) will now show a directory structure
like so:

.. code-block::  bash
   
    cd /path/to/patched-corpus
    tree -d
   
    .
    |-- test
    |   |-- test_ann
    |   |-- test_norm_cui_replaced_with_unk
    |   |-- test_note
    |   `-- test_redacted
    `-- train
        |-- train_ann
        |-- train_norm
        |-- train_note
        `-- train_redacted

Data Redaction
--------------

The redacted corpus was generated by filtering content from original
raw corpus.  All text span strings were replaced with the string
"``[redacted]``".

In contrast with how the patching script is run, this script must be
provided the direct folder containing the raw annotated files and the
direct folder to write the redacted files into.

.. code-block::  bash
    python3 \
        corpus-utils/n2c2/redact_2019_n2c2_track-3_corpus.py \
	--input-dir /path/to/raw-brat-corpus/train_ann \
	--output-dir /path/to/redacted-corpus/train_redacted
	
    python3 \
        corpus-utils/n2c2/redact_2019_n2c2_track-3_corpus.py \
	--input-dir /path/to/raw-brat-corpus/test_ann \
	--output-dir /path/to/redacted-corpus/test_redacted

		 
Links
=====

- This repository:  https://github.com/MUSC-TBIC/corpus-utils 
- The redacted corpus:  https://github.com/MUSC-TBIC/2010-i2b2-VA-Challenge-Corpus-Augmentations
- Original challenge overview page:  `2019 n2c2 Shared-Task and Workshop Track 3: n2c2/UMass Track on Clinical Concept Normalization <https://n2c2.dbmi.hms.harvard.edu/track3>`_
- Data page: `n2c2 2019 — Track 3: Clinical Concept Normalization <https://portal.dbmi.hms.harvard.edu/projects/n2c2-2019-t3/>`_

References
==========

Heider PM, Kim Y, Meystre SM. Semi-Automated Corpus Augmentation
Methods for Enriching Laboratory Test Names with Value Annotations.
AMIA Informatics Summit. 2021.

Luo YF, Sun W, Rumshisky A. `MCN: A Comprehensive Corpus for Medical
Concept Normalization
<https://www.ncbi.nlm.nih.gov/pubmed/30802545>`_. Journal of
biomedical informatics. 2019 Feb 22:103132.

Özlem Uzuner, Brett R South, Shuying Shen, Scott L DuVall, `2010
i2b2/VA challenge on concepts, assertions, and relations in clinical
text <https://doi.org/10.1136/amiajnl-2011-000203>`_, Journal of the
American Medical Informatics Association, Volume 18, Issue 5,
September 2011, Pages 552–556.
